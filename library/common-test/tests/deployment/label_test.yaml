suite: deployment label test
templates:
  - common.yaml
chart:
  appVersion: &appVer v1.2.3
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
      - equal:
          path: spec.selector.matchLabels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/name: common-test
            release: RELEASE-NAME

  - it: should pass with controller and global labels
    documentIndex: *deploymentDoc
    set:
      some_key: some_value
      controllers:
        main:
          labels:
            controller_key: controller_value
            controller_key2: "{{ .Values.some_key }}"
      global:
        labels:
          global_key: global_value
          global_key2: "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: metadata.labels
          value:
            controller_key: controller_value
            controller_key2: some_value
            global_key: global_value
            global_key2: some_value
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME

  - it: should pass with podLabels set
    documentIndex: *deploymentDoc
    set:
      some_key: some_value2
      controllers:
        main:
          pod:
            labels:
              test: some_value
              test2: "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: spec.template.metadata.labels.test2
          value: some_value2
      - equal:
          path: spec.template.metadata.labels.test
          value: some_value
