
suite: container in deployment lifecycle test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should pass with single postStart lifecycle set
    documentIndex: *deploymentDoc
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command: some_command
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - some_command

  - it: should pass with single postStart lifecycle set from tpl
    documentIndex: *deploymentDoc
    set:
      some_key: some_command
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command: "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - some_command

  - it: should pass with postStart lifecycle set
    documentIndex: *deploymentDoc
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command:
                      - /bin/bash
                      - test
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - test

  - it: should pass with postStart lifecycle set from tpl
    documentIndex: *deploymentDoc
    set:
      some_key: some_value
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command:
                      - /bin/bash
                      - "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            postStart:
              exec:
                command:
                  - /bin/bash
                  - some_value

  - it: should pass with single preStop lifecycle set
    documentIndex: *deploymentDoc
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command: some_command
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - some_command

  - it: should pass with single preStop lifecycle set from tpl
    documentIndex: *deploymentDoc
    set:
      some_key: some_command
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command: "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - some_command

  - it: should pass with preStop lifecycle set
    documentIndex: *deploymentDoc
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command:
                      - /bin/bash
                      - test
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - test

  - it: should pass with preStop lifecycle set from tpl
    documentIndex: *deploymentDoc
    set:
      some_key: some_value
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command:
                      - /bin/bash
                      - "{{ .Values.some_key }}"
    asserts:
      - equal:
          path: spec.template.spec.containers[0].lifecycle
          value:
            preStop:
              exec:
                command:
                  - /bin/bash
                  - some_value

  - it: should fail with invalid key
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStart:
                    command: something
    asserts:
      - failedTemplate:
          errorMessage: Invalid key (preStart) in lifecycle. Valid keys are preStop and postStart

  - it: should fail with no command in preStop
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command: ""
    asserts:
      - failedTemplate:
          errorMessage: No commands were given for preStop lifecycle hook

  - it: should fail with no command in postStart
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command: ""
    asserts:
      - failedTemplate:
          errorMessage: No commands were given for postStart lifecycle hook

  - it: should fail with no command in preStop
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  preStop:
                    command: ""
    asserts:
      - failedTemplate:
          errorMessage: No commands were given for preStop lifecycle hook

  - it: should fail with no command in postStart
    set:
      controllers:
        main:
          pod:
            containers:
              main:
                lifecycle:
                  postStart:
                    command: ""
    asserts:
      - failedTemplate:
          errorMessage: No commands were given for postStart lifecycle hook
