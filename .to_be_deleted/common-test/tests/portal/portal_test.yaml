suite: portal port test
templates:
  - common.yaml
chart:
  appVersion: &appVer v1.2.3
tests:
  - it: should pass with default values
    documentIndex: &portalDoc 2
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: ConfigMap
      - isAPIVersion:
          of: v1

  - it: should pass with portal disabled
    set:
      portal:
        enabled: false
    asserts:
      - hasDocuments:
          count: 2

  - it: should pass with default labels
    documentIndex: *portalDoc
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME

  - it: should pass with global labels
    documentIndex: *portalDoc
    set:
      global:
        labels:
          some_key: some_value
          some_key1: some_value1
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: some_value
            some_key1: some_value1

  - it: should pass with global labels from tpl
    documentIndex: *portalDoc
    set:
      k1: some_value
      k2: some_value1
      global:
        labels:
          some_key: "{{ .Values.k1 }}"
          some_key1: "{{ .Values.k2 }}"
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: some_value
            some_key1: some_value1

  - it: should pass with default annotations
    documentIndex: *portalDoc
    asserts:
      - isNull:
          path: metadata.annotations

  - it: should pass with global annotations
    documentIndex: *portalDoc
    set:
      global:
        annotations:
          some_key: some_value
          some_key1: some_value1
    asserts:
      - equal:
          path: metadata.annotations
          value:
            some_key: some_value
            some_key1: some_value1

  - it: should pass with global annotations from tpl
    documentIndex: *portalDoc
    set:
      k1: some_value
      k2: some_value1
      global:
        annotations:
          some_key: "{{ .Values.k1 }}"
          some_key1: "{{ .Values.k2 }}"
    asserts:
      - equal:
          path: metadata.annotations
          value:
            some_key: some_value
            some_key1: some_value1
