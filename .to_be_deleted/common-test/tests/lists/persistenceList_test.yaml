suite: persistenceList test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should pass with persistenceList defined
    documentIndex: *deploymentDoc
    set:
      persistenceList:
        - enabled: true
          type: pvc
          mountPath: /some-path
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: persist-list-0
            mountPath: /some-path
      - contains:
          path: spec.template.spec.volumes
          content:
            name: persist-list-0
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-persist-list-0

  - it: should pass with persistenceList defined
    documentIndex: *deploymentDoc
    set:
      persistenceList:
        - enabled: true
          type: nfs
          server: 10.10.10.100
          path: /nfs/path
          mountPath: /some-path
        - enabled: true
          type: hostPath
          mountPath: /some-path
          hostPath: /mnt/pool/dataset/dir
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: persist-list-0
            mountPath: /some-path
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: persist-list-1
            mountPath: /some-path
      - contains:
          path: spec.template.spec.volumes
          content:
            name: persist-list-0
            nfs:
              server: 10.10.10.100
              path: /nfs/path
      - contains:
          path: spec.template.spec.volumes
          content:
            name: persist-list-1
            hostPath:
              path: /mnt/pool/dataset/dir

  - it: should pass with persistenceList defined as readOnly
    documentIndex: *deploymentDoc
    set:
      persistenceList:
        - enabled: true
          type: pvc
          mountPath: /some-path
          readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: persist-list-0
            mountPath: /some-path
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: persist-list-0
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-persist-list-0

  - it: should pass with persistenceList defined, validateHostPath true and a malicious not allowed path
    documentIndex: *deploymentDoc
    set:
      persistenceList:
        - enabled: true
          type: hostPath
          mountPath: /some-path
          hostPath: /mnt
          validateHostPath: true
    asserts:
      - failedTemplate:
          errorMessage: Invalid hostPath (/mnt). Allowed hostPaths are valid paths under a given pool. e.g. /mnt/POOL/DATASET, /mnt/POOL/DATASET/DIRECTORY
