suite: deployment ixVolumes volume test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should fail without set datasetName on ixVolume type
    set:
      persistence:
        some_volume:
          type: ixVolume
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: Item (some_volume) is set as ixVolume type, but has no <datasetName> defined

  - it: should fail with set datasetName on ixVolume type but empty ixVolumes
    set:
      persistence:
        some_volume:
          type: ixVolume
          datasetName: ix-app
          enabled: true
          noMount: true
      ixVolumes: []
    asserts:
      - failedTemplate:
          errorMessage: Key <ixVolumes> is empty. But persistence volumes of type ixVolumes is defined.

  - it: should fail on ixVolume type with datasetName set but missing path in ixVolumes
    set:
      ixVolumes:
        - /mnt/pool/ix-applications/ix-other-app
      persistence:
        some_volume:
          type: ixVolume
          datasetName: ix-app
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: Dataset Name (ix-app) on item (some_volume) does not exist in ixVolumes list

  - it: should fail on ixVolume type with hostPath set
    set:
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
      persistence:
        some_volume:
          type: ixVolume
          datasetName: ix-app
          hostPath: /mnt/pool/test
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: Item (some_volume), is set as ixVolume but has hostPath defined. This is automatically calculated.

  - it: should fail with added ixVolume and invalid hostPathType set
    documentIndex: *deploymentDoc
    set:
      hostType: invalid
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
      persistence:
        volume1:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          hostPathType: "{{ .Values.hostType }}"
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: Invalid <hostPathType> option (invalid) on item (volume1). Valid options are DirectoryOrCreate, Directory, FileOrCreate, File, Socket, CharDevice and BlockDevice

  - it: should pass with added ixVolume
    documentIndex: *deploymentDoc
    set:
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
      persistence:
        volume1:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            hostPath:
              path: /mnt/pool/ix-applications/ix-app

  - it: should pass with added ixVolume and hostPathType set
    documentIndex: *deploymentDoc
    set:
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
      persistence:
        volume1:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          hostPathType: Directory
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            hostPath:
              path: /mnt/pool/ix-applications/ix-app
              type: Directory

  - it: should pass with added ixVolume and hostPathType set from tpl
    documentIndex: *deploymentDoc
    set:
      hostType: Directory
      ixVolumes:
        - /mnt/pool/ix-applications/ix-app
      persistence:
        volume1:
          enabled: true
          type: ixVolume
          datasetName: ix-app
          hostPathType: "{{ .Values.hostType }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            hostPath:
              path: /mnt/pool/ix-applications/ix-app
              type: Directory
