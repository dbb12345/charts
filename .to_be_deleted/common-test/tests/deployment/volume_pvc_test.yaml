suite: deployment pvc volume test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should pass with added PVC
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: pvc
          enabled: true
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-some_volume

  - it: should pass with added PVC and existingClaim
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: pvc
          enabled: true
          existingClaim: some_existing_claim
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: some_existing_claim

  - it: should pass with added PVC and existingClaim from tpl
    documentIndex: *deploymentDoc
    set:
      claim: some_existing_claim
      persistence:
        some_volume:
          type: pvc
          enabled: true
          existingClaim: "{{ .Values.claim }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: some_existing_claim

  - it: should pass with added PVC and nameOverride
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: pvc
          enabled: true
          nameOverride: some_claim
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-some_claim

  - it: should pass with added PVC and nameOverride from tpl
    documentIndex: *deploymentDoc
    set:
      claim: some_claim
      persistence:
        some_volume:
          type: pvc
          enabled: true
          nameOverride: "{{ .Values.claim }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: RELEASE-NAME-common-test-some_claim

  - it: should pass with added PVC and forceName
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: pvc
          enabled: true
          forceName: forced_name
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: forced_name

  - it: should pass with added PVC and forceName from tpl
    documentIndex: *deploymentDoc
    set:
      claim: forced_name
      persistence:
        some_volume:
          type: pvc
          enabled: true
          forceName: "{{ .Values.claim }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            persistentVolumeClaim:
              claimName: forced_name
