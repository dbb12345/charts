suite: deployment configMap volume test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should fail with not set objectName on configMap
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: objectName not set for persistence item some_volume

  - it: should fail with not set objectName on configmap
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: objectName not set for persistence item some_volume

  - it: should fail with not set objectName on configMap
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: objectName not set for persistence item some_volume

  - it: should pass with added configMap
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            configMap:
              name: some_object_name

  - it: should fail with added configMap and defaultMode as int
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: 0777
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: <defaultMode> (511, converted to octal) is not valid format. Valid format is string with 4 digits <0777>.

  - it: should pass with added configMap and defaultMode as string
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: "0777"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            configMap:
              name: some_object_name
              defaultMode: 0777

  - it: should fail with added configMap and defaultMode as int from tpl
    documentIndex: *deploymentDoc
    set:
      mode: 644
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: "{{ .Values.mode }}"
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: <defaultMode> (644, converted to octal) is not valid format. Valid format is string with 4 digits <0777>.

  - it: should pass with added configMap and defaultMode as string from tpl
    documentIndex: *deploymentDoc
    set:
      mode: "0644"
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          defaultMode: "{{ .Values.mode }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            configMap:
              name: some_object_name
              defaultMode: 0644

  - it: should pass with added configMap and items
    documentIndex: *deploymentDoc
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          items:
            - key: some_key
              path: some_path
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            configMap:
              name: some_object_name
              items:
                - key: some_key
                  path: some_path

  - it: should fail with added configMap and no key on items
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          items:
            - path: some_path
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: No key was given for persistence item some_volume

  - it: should fail with added configMap and no path on items
    set:
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          items:
            - key: some_key
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: No path was given for persistence item some_volume

  - it: should pass with added configMap and items from tpl
    documentIndex: *deploymentDoc
    set:
      key: some_key
      path: some_path
      persistence:
        some_volume:
          type: configMap
          enabled: true
          objectName: some_object_name
          items:
            - key: "{{ .Values.key }}"
              path: "{{ .Values.path }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: some_volume
            configMap:
              name: some_object_name
              items:
                - key: some_key
                  path: some_path
