
suite: primary service utils test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: /
              port: 65535
              scheme: HTTP
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5

  - it: should fail with more than 1 primary services
    set:
      service:
        main:
          primary: true
        other:
          enabled: true
          primary: true
          ports:
            other:
              enabled: true
              port: 80
    asserts:
      - failedTemplate:
          errorMessage: More than one services are set as primary. This is not supported.


  - it: should pass with main service set as primary and other not
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          primary: true
          ports:
            main:
              protocol: TCP
              port: 12345
        other:
          primary: false
          ports:
            main:
              protocol: TCP
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10

  - it: should pass with no service set as primary
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          primary: false
          ports:
            main:
              protocol: TCP
              port: 12345
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10

  - it: should pass with different service set as primary
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          primary: false
        other:
          enabled: true
          primary: true
          ports:
            other:
              enabled: true
              protocol: TCP
              port: 12345
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10
