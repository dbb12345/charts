
suite: primary port utils test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            httpGet:
              path: /
              port: 65535
              scheme: HTTP
            failureThreshold: 5
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5

  - it: should pass with no port set as primary
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          ports:
            main:
              primary: false
              protocol: TCP
              port: 12345
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10

  - it: should pass with main port set as primary and other not
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          ports:
            main:
              primary: true
              protocol: TCP
              port: 12345
            other:
              primary: false
              protocol: TCP
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10

  - it: should pass with different port set as primary
    documentIndex: *deploymentDoc
    set:
      service:
        main:
          ports:
            main:
              primary: false
            other:
              enabled: true
              primary: true
              protocol: TCP
              port: 12345
      probes:
        liveness:
          type: auto
    asserts:
      - equal:
          path: spec.template.spec.containers[0].livenessProbe
          value:
            tcpSocket:
              port: 12345
            initialDelaySeconds: 10
            failureThreshold: 5
            timeoutSeconds: 5
            periodSeconds: 10

  - it: should fail with more than 1 primary ports
    set:
      service:
        main:
          ports:
            main:
              primary: true
            other_port:
              enabled: true
              primary: true
              port: 1234
    asserts:
      - failedTemplate:
          errorMessage: More than one ports are set as primary in the primary service. This is not supported.
