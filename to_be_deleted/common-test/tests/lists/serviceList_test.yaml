suite: serviceList test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should pass with serviceList defined (container)
    documentIndex: *deploymentDoc
    set:
      serviceList:
        - enabled: true
          type: ClusterIP
          portsList:
            - enabled: true
              primary: true
              protocol: HTTP
              targetPort: 1234
              port: 3425
            - enabled: true
              protocol: HTTP
              targetPort: 12346
              port: 3427
        - enabled: true
          type: NodePort
          portsList:
            - enabled: true
              protocol: HTTP
              targetPort: 12345
              nodePort: 30000
              port: 3426
    asserts:
      - isSubset:
          path: spec.template.spec.containers[0]
          content:
            ports:
              - containerPort: 65535
                name: main
                protocol: TCP
              - name: port-list-0-0
                containerPort: 1234
                protocol: TCP
              - name: port-list-0-1
                containerPort: 12346
                protocol: TCP
              - name: port-list-1-0
                containerPort: 12345
                protocol: TCP

  - it: should pass with serviceList defined (service 1/2)
    documentIndex: &serviceDoc 3
    set:
      serviceList:
        - enabled: true
          type: ClusterIP
          portsList:
            - enabled: true
              primary: true
              protocol: HTTP
              targetPort: 1234
              port: 3425
            - enabled: true
              protocol: HTTP
              targetPort: 12346
              port: 3427
        - enabled: true
          type: NodePort
          portsList:
            - enabled: true
              protocol: HTTP
              targetPort: 12345
              nodePort: 30000
              port: 3426
    asserts:
      - isSubset:
          path: spec
          content:
            type: NodePort
            ports:
              - name: port-list-1-0
                port: 3426
                protocol: TCP
                targetPort: 12345
                nodePort: 30000

  - it: should pass with serviceList defined (service 2/2)
    documentIndex: &otherServiceDoc 2
    set:
      serviceList:
        - enabled: true
          type: ClusterIP
          portsList:
            - enabled: true
              primary: true
              protocol: HTTP
              targetPort: 1234
              port: 3425
            - enabled: true
              protocol: HTTP
              targetPort: 12346
              port: 3427
        - enabled: true
          type: NodePort
          portsList:
            - enabled: true
              protocol: HTTP
              targetPort: 12345
              nodePort: 30000
              port: 3426
    asserts:
      - isSubset:
          path: spec
          content:
            type: ClusterIP
            ports:
              - name: port-list-0-0
                port: 3425
                protocol: TCP
                targetPort: 1234
              - name: port-list-0-1
                port: 3427
                protocol: TCP
                targetPort: 12346

  - it: should pass with serviceList defined (portal)
    documentIndex: &portalDoc 4
    set:
      serviceList:
        - enabled: true
          type: ClusterIP
          portsList:
            - enabled: true
              primary: true
              protocol: HTTP
              targetPort: 1234
              port: 3425
            - enabled: true
              protocol: HTTP
              targetPort: 12346
              port: 3427
        - enabled: true
          type: NodePort
          portsList:
            - enabled: true
              protocol: HTTP
              targetPort: 12345
              nodePort: 30000
              port: 3426
    asserts:
      - equal:
          path: kind
          value: ConfigMap
      - equal:
          path: data
          value:
            host-main-main: $node_ip
            host-svc-list-0-port-list-0-0: $node_ip
            host-svc-list-0-port-list-0-1: $node_ip
            host-svc-list-1-port-list-1-0: $node_ip
            path-main-main: /
            path-svc-list-0-port-list-0-0: /
            path-svc-list-0-port-list-0-1: /
            path-svc-list-1-port-list-1-0: /
            port-main-main: "443"
            port-svc-list-0-port-list-0-0: "443"
            port-svc-list-0-port-list-0-1: "443"
            port-svc-list-1-port-list-1-0: "30000"
            protocol-main-main: http
            protocol-svc-list-0-port-list-0-0: http
            protocol-svc-list-0-port-list-0-1: http
            protocol-svc-list-1-port-list-1-0: http
            url-main-main: http://$node_ip:443/
            url-svc-list-0-port-list-0-0: http://$node_ip:443/
            url-svc-list-0-port-list-0-1: http://$node_ip:443/
            url-svc-list-1-port-list-1-0: http://$node_ip:30000/
