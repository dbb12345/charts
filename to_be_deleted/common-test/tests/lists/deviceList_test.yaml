suite: deviceList test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should pass with deviceList defined
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /dev/usb
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: device-0
            mountPath: /dev/usb
      - contains:
          path: spec.template.spec.volumes
          content:
            name: device-0
            hostPath:
              path: /dev/usb

  - it: should pass with deviceList defined as readOnly
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /dev/usb
          readOnly: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: device-0
            mountPath: /dev/usb
            readOnly: true
      - contains:
          path: spec.template.spec.volumes
          content:
            name: device-0
            hostPath:
              path: /dev/usb

  - it: should pass with deviceList defined, validateHostPath true and a malicious not allowed path
    documentIndex: *deploymentDoc
    set:
      deviceList:
        - enabled: true
          type: hostPath
          mountPath: /dev/usb
          hostPath: /mnt
          validateHostPath: true
    asserts:
      - failedTemplate:
          errorMessage: Invalid hostPath (/mnt). Allowed hostPaths are valid paths under a given pool. e.g. /mnt/POOL/DATASET, /mnt/POOL/DATASET/DIRECTORY
