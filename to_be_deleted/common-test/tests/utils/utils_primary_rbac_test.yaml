
suite: primary rbac utils test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    asserts:
      - hasDocuments:
          count: 3

  - it: should fail with more than 1 primary rbac
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: &rules
            - apiGroups:
                - something
              resources:
                - something
              verbs:
                - something
          subjects: &subjects
            - kind: something
              name: something
              apiGroup: something
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - failedTemplate:
          errorMessage: More than one RBACS are set as primary. This is not supported.

  - it: should pass with no rbac set as primary (Role)
    documentIndex: &roleDoc 0
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with no rbac set as primary (RoleBinding)
    documentIndex: &roleBindingDoc 1
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with no rbac set as primary (ClusterRole)
    documentIndex: *roleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with no rbac set as primary (ClusterRoleBinding)
    documentIndex: *roleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main rbac set as primary and other not (Role - main)
    documentIndex: *roleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main rbac set as primary and other not (Role - other)
    documentIndex: &otherRoleDoc 2
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other

  - it: should pass with main rbac set as primary and other not (RoleBinding - main)
    documentIndex: *roleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main rbac set as primary and other not (RoleBinding - other)
    documentIndex: &otherRoleBindingDoc 3
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other

  - it: should pass with main rbac set as primary and other not (ClusterRole - main)
    documentIndex: *roleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          clusterWide: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main rbac set as primary and other not (ClusterRole - other)
    documentIndex: *otherRoleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other

  - it: should pass with main rbac set as primary and other not (ClusterRoleBinding - main)
    documentIndex: *roleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          clusterWide: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main rbac set as primary and other not (ClusterRoleBinding - other)
    documentIndex: *otherRoleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other

  - it: should pass with other rbac set as primary and main not (Role - main)
    documentIndex: *roleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-main

  - it: should pass with other rbac set as primary and main not (Role - other)
    documentIndex: &otherRoleDoc 2
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: Role
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with other rbac set as primary and main not (RoleBinding - main)
    documentIndex: *roleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-main

  - it: should pass with other rbac set as primary and main not (RoleBinding - other)
    documentIndex: &otherRoleBindingDoc 3
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: RoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with other rbac set as primary and main not (ClusterRole - main)
    documentIndex: *roleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-main

  - it: should pass with other rbac set as primary and main not (ClusterRole - other)
    documentIndex: *otherRoleDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRole
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with other rbac set as primary and main not (ClusterRoleBinding - main)
    documentIndex: *roleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          clusterWide: true
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-main

  - it: should pass with other rbac set as primary and main not (ClusterRoleBinding - other)
    documentIndex: *otherRoleBindingDoc
    set:
      rbac:
        main:
          enabled: true
          primary: false
          rules: *rules
          subjects: *subjects
        other:
          enabled: true
          primary: true
          clusterWide: true
          rules: *rules
          subjects: *subjects
    asserts:
      - hasDocuments:
          count: 7
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
