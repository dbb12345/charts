
suite: primary serviceAccount utils test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    asserts:
      - hasDocuments:
          count: 3

  - it: should fail with more than 1 primary serviceAccounts
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: true
    asserts:
      - failedTemplate:
          errorMessage: More than one serviceAccounts are set as primary. This is not supported.

  - it: should pass with no serviceAccount set as primary
    documentIndex: &serviceAccountDoc 0
    set:
      serviceAccount:
        main:
          enabled: true
          primary: false
    asserts:
      - hasDocuments:
          count: 4
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main serviceAccount set as primary and other not (check name on main)
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: false
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with main serviceAccount set as primary and other not (check name on other)
    documentIndex: &otherServiceAccountDoc 1
    set:
      serviceAccount:
        main:
          enabled: true
          primary: true
        other:
          enabled: true
          primary: false
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-other

  - it: should pass with different serviceAccount set as primary (check name on main)
    documentIndex: *serviceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          primary: false
        other:
          enabled: true
          primary: true
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-main

  - it: should pass with different serviceAccount set as primary (check name on other)
    documentIndex: *otherServiceAccountDoc
    set:
      serviceAccount:
        main:
          enabled: true
          primary: false
        other:
          enabled: true
          primary: true
    asserts:
      - hasDocuments:
          count: 5
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test
