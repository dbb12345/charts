suite: deployment emptyDir volume test
templates:
  - common.yaml
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment
      - isNull:
          path: spec.template.spec.volume

  - it: should pass with added emptyDir volume
    documentIndex: *deploymentDoc
    set:
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          sizeLimit: 1Gi
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            emptyDir:
              sizeLimit: 1Gi

  - it: should pass with added emptyDir volume and no sizeLimit
    documentIndex: *deploymentDoc
    set:
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            emptyDir: {}

  - it: should pass with added emptyDir volume memory backed with sizeLimit
    documentIndex: *deploymentDoc
    set:
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          medium: Memory
          sizeLimit: 1Gi
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            emptyDir:
              medium: Memory
              sizeLimit: 1Gi

  - it: should pass with added emptyDir volume memory backed with sizeLimit via tpl
    documentIndex: *deploymentDoc
    set:
      some_medium: Memory
      some_size: 1Gi
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          medium: "{{ .Values.some_medium }}"
          sizeLimit: "{{ .Values.some_size }}"
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            emptyDir:
              medium: Memory
              sizeLimit: 1Gi

  - it: should pass with added emptyDir volume memory backed and no sizeLimit
    documentIndex: *deploymentDoc
    set:
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          medium: Memory
          noMount: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: volume1
            emptyDir:
              medium: Memory

  - it: should fail with added emptyDir and non Memory medium
    set:
      persistence:
        volume1:
          enabled: true
          type: emptyDir
          medium: not_memory
          noMount: true
    asserts:
      - failedTemplate:
          errorMessage: You can only set <medium> as Memory on item (volume1)
