suite: service test
templates:
  - common.yaml
chart:
  appVersion: &appVer v1.2.3
tests:
  - it: should pass with default values
    documentIndex: &deploymentDoc 0
    asserts:
      - hasDocuments:
          count: 3
      - isKind:
          of: Deployment

  - it: should fail with multiple services, without any set as primary
    set:
      service:
        main:
          enabled: true
          primary: false
          ports:
            main:
              enabled: true
              port: 65535
        main2:
          enabled: true
          primary: false
          ports:
            main2:
              enabled: true
              port: 65534
    asserts:
      - failedTemplate:
          errorMessage: At least one Service must be set as primary

  - it: should fail without externalName on ExternalName service
    set:
      service:
        main:
          type: ExternalName
          externalName: ""
    asserts:
      - failedTemplate:
          errorMessage: <externalName> is required when service type is set to ExternalName

  - it: should fail with invalid externalTrafficPolicy
    set:
      service:
        main:
          type: LoadBalancer
          externalTrafficPolicy: invalid_traffic_policy
    asserts:
      - failedTemplate:
          errorMessage: Invalid option (invalid_traffic_policy) for <externalTrafficPolicy>. Valid options are Cluster and Local

  - it: should fail with invalid sessionAffinity
    set:
      service:
        main:
          sessionAffinity: invalid_affinity
    asserts:
      - failedTemplate:
          errorMessage: Invalid option (invalid_affinity) for <sessionAffinity>. Valid options are ClientIP and None

  - it: should fail with invalid timeoutSeconds in sessionAffinityConfig negative
    set:
      service:
        main:
          sessionAffinity: ClientIP
          sessionAffinityConfig:
            clientIP:
              timeoutSeconds: -1
    asserts:
      - failedTemplate:
          errorMessage: Invalid value (-1) for <sessionAffinityConfig.ClientIP.timeoutSeconds>. Valid values must be with 0 and 86400

  - it: should fail with invalid timeoutSeconds in sessionAffinityConfig too high
    set:
      service:
        main:
          sessionAffinity: ClientIP
          sessionAffinityConfig:
            clientIP:
              timeoutSeconds: 86401
    asserts:
      - failedTemplate:
          errorMessage: Invalid value (86401) for <sessionAffinityConfig.ClientIP.timeoutSeconds>. Valid values must be with 0 and 86400

  - it: should fail with invalid ipFamilyPolicy
    set:
      service:
        main:
          ipFamilyPolicy: invalid_fam_policy
    asserts:
      - failedTemplate:
          errorMessage: Invalid option (invalid_fam_policy) for <ipFamilyPolicy>. Valid options are SingleStack, PreferDualStack, RequireDualStack

  - it: should fail with invalid ipFamily
    set:
      service:
        main:
          ipFamilies:
            - invalid_family
    asserts:
      - failedTemplate:
          errorMessage: Invalid option (invalid_family) for <ipFamilies[]>. Valid options are IPv4 and IPv6

  - it: should fail with externalIP type but no externalIP defined
    set:
      service:
        main:
          type: ExternalIP
          externalIP: []
    asserts:
      - failedTemplate:
          errorMessage: Service type is set to ExternalIP, but no externalIP is defined.

  - it: should pass with correct apiVersion
    documentIndex: &serviceDoc 1
    asserts:
      - isKind:
          of: Service
      - isAPIVersion:
          of: v1

  - it: should pass with correct name
    documentIndex: *serviceDoc
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test

  - it: should pass with nameOverride on other service
    documentIndex: &otherServiceDoc 2
    set:
      service:
        other:
          enabled: true
          nameOverride: something
          ports:
            other:
              enabled: true
              port: 80
    asserts:
      - equal:
          path: metadata.name
          value: RELEASE-NAME-common-test-something

  - it: should pass with addAnnotations set to true
    documentIndex: *serviceDoc
    set:
      addAnnotations:
        traefik: true
        metallb: true
      service:
        main:
          type: LoadBalancer
          ports:
            main:
              protocol: HTTPS
    asserts:
      - equal:
          path: metadata.annotations
          value:
            traefik.ingress.kubernetes.io/service.serversscheme: https
            metallb.universe.tf/allow-shared-ip: RELEASE-NAME-common-test

  - it: should pass with addAnnotations set to false
    documentIndex: *serviceDoc
    set:
      addAnnotations:
        traefik: false
        metallb: false
      service:
        main:
          type: LoadBalancer
          ports:
            main:
              protocol: HTTPS
    asserts:
      - isNull:
          path: metadata.annotations

  - it: should pass with addAnnotations set to true and annotations
    documentIndex: *serviceDoc
    set:
      addAnnotations:
        traefik: true
        metallb: true
      service:
        main:
          type: LoadBalancer
          annotations:
            some_key: value
            some_key1: value1
          ports:
            main:
              protocol: HTTPS
    asserts:
      - equal:
          path: metadata.annotations
          value:
            traefik.ingress.kubernetes.io/service.serversscheme: https
            metallb.universe.tf/allow-shared-ip: RELEASE-NAME-common-test
            some_key: value
            some_key1: value1

  - it: should pass with addAnnotations set to true and global annotations
    documentIndex: *serviceDoc
    set:
      global:
        annotations:
          some_key: value
          some_key1: value1
      addAnnotations:
        traefik: true
        metallb: true
      service:
        main:
          type: LoadBalancer
          ports:
            main:
              protocol: HTTPS
    asserts:
      - equal:
          path: metadata.annotations
          value:
            traefik.ingress.kubernetes.io/service.serversscheme: https
            metallb.universe.tf/allow-shared-ip: RELEASE-NAME-common-test
            some_key: value
            some_key1: value1

  - it: should pass with addAnnotations set to true and overridden metalLBSharedKey
    documentIndex: *serviceDoc
    set:
      addAnnotations:
        traefik: true
        metallb: true
      service:
        main:
          type: LoadBalancer
          metalLBSharedKey: custom-shared-key
          ports:
            main:
              protocol: HTTPS
    asserts:
      - equal:
          path: metadata.annotations
          value:
            traefik.ingress.kubernetes.io/service.serversscheme: https
            metallb.universe.tf/allow-shared-ip: custom-shared-key

  - it: should pass with labels
    documentIndex: *serviceDoc
    set:
      service:
        main:
          labels:
            some_key: value
            some_key1: value1
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: value
            some_key1: value1

  - it: should pass with labels and global labels
    documentIndex: *serviceDoc
    set:
      global:
        labels:
          some_key2: value2
          some_key3: value3
      service:
        main:
          labels:
            some_key: value
            some_key1: value1
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: value
            some_key1: value1
            some_key2: value2
            some_key3: value3

  - it: should pass with labels (Endpoints)
    documentIndex: &endpointsDoc 2
    set:
      service:
        main:
          type: ExternalIP
          externalIP: 10.10.10.100
          labels:
            some_key: value
            some_key1: value1
    asserts:
      - isKind:
          of: Endpoints
      - isAPIVersion:
          of: v1
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: value
            some_key1: value1

  - it: should pass with labels and global labels (Endpoints)
    documentIndex: *endpointsDoc
    set:
      global:
        labels:
          some_key2: value2
          some_key3: value3
      service:
        main:
          type: ExternalIP
          externalIP: 10.10.10.100
          labels:
            some_key: value
            some_key1: value1
    asserts:
      - equal:
          path: metadata.labels
          value:
            app: common-test
            app.kubernetes.io/instance: RELEASE-NAME
            app.kubernetes.io/managed-by: Helm
            app.kubernetes.io/name: common-test
            app.kubernetes.io/version: *appVer
            helm-revision: "0"
            helm.sh/chart: common-test-1.0.0
            release: RELEASE-NAME
            some_key: value
            some_key1: value1
            some_key2: value2
            some_key3: value3

  - it: should pass with annotations (Endpoints)
    documentIndex: *endpointsDoc
    set:
      addAnnotations:
        traefik: true
        metallb: true
      service:
        main:
          type: ExternalIP
          externalIP: 10.10.10.100
          annotations:
            some_key: value
            some_key1: value1
    asserts:
      - equal:
          path: metadata.annotations
          value:
            some_key: value
            some_key1: value1

  - it: should pass with global annotations (Endpoints)
    documentIndex: *endpointsDoc
    set:
      global:
        annotations:
          some_key: value
          some_key1: value1
      service:
        main:
          type: ExternalIP
          externalIP: 10.10.10.100
    asserts:
      - equal:
          path: metadata.annotations
          value:
            some_key: value
            some_key1: value1
